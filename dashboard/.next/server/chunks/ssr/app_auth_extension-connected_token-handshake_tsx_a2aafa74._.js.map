{"version":3,"sources":["../../../../app/auth/extension-connected/token-handshake.tsx"],"sourcesContent":["'use client'\n\nimport { useEffect, useRef, useState } from 'react'\nimport { Button } from '@/components/ui/button'\n\n/**\n * Client component that calls the /api/extension/token endpoint\n * and stores the result in a hidden DOM element for the extension\n * content script (extension-auth.js) to read.\n *\n * No raw user ID is exposed in the DOM. Instead, the extension\n * receives a cryptographically random, hashed-server-side token.\n */\nexport function ExtensionTokenHandshake() {\n  const hasRun = useRef(false)\n  const [status, setStatus] = useState('Generating secure token...')\n  const [isError, setIsError] = useState(false)\n  const [showHelp, setShowHelp] = useState(false)\n  const [authData, setAuthData] = useState<{ token: string; userId: string } | null>(null)\n\n  useEffect(() => {\n    if (hasRun.current) return\n    hasRun.current = true\n\n    console.log('[v0] TokenHandshake: Starting token generation')\n\n    async function generateToken() {\n      try {\n        console.log('[v0] TokenHandshake: Calling /api/extension/token')\n        const res = await fetch('/api/extension/token', { method: 'POST' })\n\n        if (!res.ok) {\n          const err = await res.json().catch(() => ({ error: 'Unknown error' }))\n          console.error('[v0] TokenHandshake: API error', err)\n          throw new Error(err.error || 'Token generation failed')\n        }\n\n        const { token, userId } = await res.json()\n        console.log('[v0] TokenHandshake: Token received, userId:', userId)\n\n        // Write token data to DOM attributes for extension-auth.js\n        const dataEl = document.getElementById('extension-auth-data')\n        if (dataEl) {\n          dataEl.setAttribute('data-ext-token', token)\n          dataEl.setAttribute('data-user-id', userId)\n          console.log('[v0] TokenHandshake: Token written to DOM')\n        } else {\n          console.error('[v0] TokenHandshake: extension-auth-data element not found')\n        }\n\n        setAuthData({ token, userId })\n\n        setStatus('Waiting for extension to sync...')\n        setIsError(false)\n\n        // Try to trigger a storage event manually for the extension\n        // This works if the extension has already set up storage before\n        try {\n          // Dispatch a custom event that popup.js can listen for\n          window.postMessage({\n            type: 'XREPLY_AUTH_TOKEN',\n            token: token,\n            userId: userId\n          }, '*')\n          console.log('[v0] TokenHandshake: Posted message to window')\n        } catch (e) {\n          console.error('[v0] TokenHandshake: Failed to post message:', e)\n        }\n\n        // Check if the extension picked up the token after 3 seconds\n        setTimeout(() => {\n          const currentToken = dataEl?.getAttribute('data-ext-token')\n          if (currentToken) {\n            console.log('[v0] TokenHandshake: Token still in DOM after 3s - extension script not running')\n            setShowHelp(true)\n            setStatus('Extension not detected')\n          }\n        }, 3000)\n\n      } catch (err) {\n        console.error('[v0] TokenHandshake: Error', err)\n        setStatus(\n          err instanceof Error\n            ? err.message\n            : 'Failed to generate token. Please try again.'\n        )\n        setIsError(true)\n      }\n    }\n\n    generateToken()\n  }, [])\n\n  const handleOpenExtension = () => {\n    alert('Now click the X Reply Generator extension icon in your browser toolbar to complete the connection.')\n  }\n\n  if (showHelp) {\n    return (\n      <div className=\"flex flex-col gap-4 max-w-md\">\n        <div className=\"rounded-lg border border-border bg-muted/50 p-4\">\n          <p className=\"text-sm font-semibold mb-3\">Complete the connection:</p>\n          <ol className=\"text-sm text-muted-foreground list-decimal list-inside space-y-2 mb-4\">\n            <li>Click the <strong>X Reply Generator</strong> icon in your browser toolbar</li>\n            <li>The extension popup will detect your authentication automatically</li>\n          </ol>\n          <Button\n            onClick={handleOpenExtension}\n            className=\"w-full\"\n          >\n            Open Extension Popup\n          </Button>\n        </div>\n\n        <details className=\"text-xs text-muted-foreground\">\n          <summary className=\"cursor-pointer font-medium mb-2\">Still not working? Try this:</summary>\n          <ol className=\"list-decimal list-inside space-y-1.5 mt-2 ml-2\">\n            <li>Open <kbd className=\"px-1 py-0.5 rounded bg-muted\">chrome://extensions</kbd></li>\n            <li>Find &quot;X Reply Generator&quot;</li>\n            <li>Click the reload icon (circular arrow)</li>\n            <li>Close and reopen the extension popup</li>\n          </ol>\n        </details>\n      </div>\n    )\n  }\n\n  return (\n    <>\n      <p\n        id=\"extension-auth-status\"\n        className=\"text-sm text-muted-foreground\"\n        style={{ color: isError ? '#ef4444' : undefined }}\n      >\n        {status}\n      </p>\n      {authData && (\n        <>\n          <input type=\"hidden\" id=\"__ATOMIX_TOKEN__\" value={authData.token} />\n          <input type=\"hidden\" id=\"__ATOMIX_USER_ID__\" value={authData.userId} />\n        </>\n      )}\n    </>\n  )\n}\n"],"names":[],"mappings":"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"}