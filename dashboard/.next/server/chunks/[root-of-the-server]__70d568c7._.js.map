{"version":3,"sources":["../../../lib/logger.ts","../../../lib/cors.ts","../../../lib/verify-extension-token.ts"],"sourcesContent":["/**\n * Structured logger for serverless environments.\n *\n * Outputs JSON to stdout/stderr so Vercel Log Drains, Axiom, Datadog,\n * or any log aggregator can parse, filter, and alert on events.\n *\n * Usage:\n *   import { logger } from '@/lib/logger'\n *   logger.error('webhook.signature_invalid', { ip, path })\n *   logger.warn('rate_limit.exceeded', { userId, endpoint })\n *   logger.info('generate.success', { userId, model, tokens })\n */\n\ntype LogLevel = 'info' | 'warn' | 'error'\n\ninterface LogEntry {\n  level: LogLevel\n  event: string\n  timestamp: string\n  [key: string]: unknown\n}\n\nfunction emit(level: LogLevel, event: string, meta?: Record<string, unknown>) {\n  const entry: LogEntry = {\n    level,\n    event,\n    timestamp: new Date().toISOString(),\n    ...meta,\n  }\n\n  const line = JSON.stringify(entry)\n\n  switch (level) {\n    case 'error':\n      console.error(line)\n      break\n    case 'warn':\n      console.warn(line)\n      break\n    default:\n      console.log(line)\n  }\n}\n\nexport const logger = {\n  info: (event: string, meta?: Record<string, unknown>) => emit('info', event, meta),\n  warn: (event: string, meta?: Record<string, unknown>) => emit('warn', event, meta),\n  error: (event: string, meta?: Record<string, unknown>) => emit('error', event, meta),\n\n  /** Convenience: log an Error object with stack trace */\n  exception: (event: string, err: unknown, meta?: Record<string, unknown>) => {\n    const errorInfo =\n      err instanceof Error\n        ? { errorMessage: err.message, errorStack: err.stack }\n        : { errorMessage: String(err) }\n    emit('error', event, { ...errorInfo, ...meta })\n  },\n\n  /** Security-relevant event (auth failure, rate limit, suspicious input) */\n  security: (event: string, meta?: Record<string, unknown>) =>\n    emit('warn', event, { ...meta, security: true }),\n}\n\n/**\n * Extract client IP from request headers (Vercel sets x-forwarded-for).\n */\nexport function getClientIp(request: Request): string {\n  return (\n    request.headers.get('x-forwarded-for')?.split(',')[0]?.trim() ||\n    request.headers.get('x-real-ip') ||\n    'unknown'\n  )\n}\n","const ALLOWED_ORIGINS = [\n  'https://atomix.guru',\n  'chrome-extension://',\n]\n\nif (process.env.NODE_ENV === 'development') {\n  ALLOWED_ORIGINS.push('http://localhost:3000')\n}\n\nexport function isOriginAllowed(origin: string | null): boolean {\n  return true // Allow all origins for the extension API\n}\n\nexport function getCorsHeaders(origin: string | null) {\n  // Dynamically reflect the exact origin back. If null, fallback to '*'\n  const allowedOrigin = origin || '*'\n\n  return {\n    'Access-Control-Allow-Origin': allowedOrigin,\n    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    'Access-Control-Max-Age': '86400',\n    Vary: 'Origin',\n  }\n}\n","import crypto from 'crypto'\nimport { createClient } from '@supabase/supabase-js'\n\nfunction getSupabaseAdmin() {\n  return createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n  )\n}\n\ninterface VerifyResult {\n  valid: boolean\n  userId?: string\n  error?: string\n}\n\n/**\n * Verifies an extension token sent via the Authorization header.\n * Tokens are hashed before lookup so the raw token is never stored.\n */\nexport async function verifyExtensionToken(\n  request: Request\n): Promise<VerifyResult> {\n  const authHeader = request.headers.get('authorization')\n\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return { valid: false, error: 'Missing or malformed Authorization header' }\n  }\n\n  const rawToken = authHeader.slice(7).trim()\n\n  if (!rawToken || rawToken.length < 32) {\n    return { valid: false, error: 'Invalid token format' }\n  }\n\n  // Hash the incoming token\n  const tokenHash = crypto\n    .createHash('sha256')\n    .update(rawToken)\n    .digest('hex')\n\n  const admin = getSupabaseAdmin()\n\n  const { data, error } = await admin\n    .from('extension_tokens')\n    .select('user_id, expires_at')\n    .eq('token_hash', tokenHash)\n    .single()\n\n  if (error || !data) {\n    return { valid: false, error: 'Invalid or expired token' }\n  }\n\n  // Check expiry\n  if (new Date(data.expires_at) < new Date()) {\n    // Clean up expired token\n    await admin.from('extension_tokens').delete().eq('token_hash', tokenHash)\n    return { valid: false, error: 'Token has expired. Please reconnect in the extension.' }\n  }\n\n  return { valid: true, userId: data.user_id }\n}\n"],"names":[],"mappings":"s3BAsBA,SAAS,EAAK,CAAe,CAAE,CAAa,CAAE,CAA8B,EAQ1E,IAAM,EAAO,KAAK,SAAS,CAPH,AAOI,OAN1B,QACA,EACA,UAAW,IAAI,OAAO,WAAW,GACjC,GAAG,CAAI,AACT,GAIA,OAAQ,GACN,IAAK,QACH,QAAQ,KAAK,CAAC,GACd,KACF,KAAK,OACH,QAAQ,IAAI,CAAC,GACb,KACF,SACE,QAAQ,GAAG,CAAC,EAChB,CACF,CAwBO,SAAS,EAAY,CAAgB,EAC1C,OACE,EAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB,MAAM,IAAI,CAAC,EAAE,EAAE,QACvD,EAAQ,OAAO,CAAC,GAAG,CAAC,cACpB,SAEJ,qCA5BsB,CACpB,KAAM,CAAC,EAAe,IAAmC,EAAK,OAAQ,EAAO,GAC7E,KAAM,CAAC,EAAe,IAAmC,EAAK,OAAQ,EAAO,GAC7E,MAAO,CAAC,EAAe,IAAmC,EAAK,QAAS,EAAO,GAG/E,UAAW,CAAC,EAAe,EAAc,KAKvC,EAAK,QAAS,EAAO,CADa,GAFhC,aAAe,MACX,CAAE,aAAc,EAAI,OAAO,CAAE,WAAY,EAAI,KAAK,AAAC,EACnD,CAAE,aAAc,OAAO,EAAK,CACX,CAAc,EAAX,CAAc,CAAI,AAAC,EAC/C,EAGA,GAJqC,MAI3B,CAAC,EAAe,IACxB,EAAK,OAAQ,EAAO,CAAE,GAAG,CAAI,CAAE,UAAU,CAAK,EAClD,iGChDO,SAAS,EAAe,CAAqB,EAIlD,MAAO,CACL,8BAHoB,CAGW,EAHD,IAI9B,+BAAgC,qBAChC,+BAAgC,8BAChC,yBAA0B,QAC1B,KAAM,QACR,CACF,qCCxBA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAmBO,eAAe,EACpB,CAAgB,EAEhB,IAAM,EAAa,EAAQ,OAAO,CAAC,GAAG,CAAC,iBAEvC,GAAI,CAAC,GAAc,CAAC,EAAW,UAAU,CAAC,WACxC,CADoD,KAC7C,CAAE,OAAO,EAAO,MAAO,2CAA4C,EAG5E,IAAM,EAAW,EAAW,KAAK,CAAC,GAAG,IAAI,GAEzC,GAAI,CAAC,GAAY,EAAS,MAAM,CAAG,GACjC,CADqC,KAC9B,CAAE,MAAO,GAAO,MAAO,sBAAuB,EAIvD,IAAM,EAAY,EAAA,OAAM,CACrB,UAAU,CAAC,UACX,MAAM,CAAC,GACP,MAAM,CAAC,OAEJ,EArCC,CAAA,EAAA,EAAA,CAqCO,WArCP,AAAY,EACjB,QAAQ,GAAG,CAAC,wBAAwB,CACpC,QAAQ,GAAG,CAAC,yBAAyB,EAqCjC,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,oBACL,MAAM,CAAC,uBACP,EAAE,CAAC,aAAc,GACjB,MAAM,UAET,AAAI,GAAS,CAAC,EACL,CAAE,GADS,GACF,GAAO,MAAO,0BAA2B,EAIvD,IAAI,KAAK,EAAK,UAAU,EAAI,IAAI,MAElC,EAF0C,IAEpC,EAAM,IAAI,CAAC,oBAAoB,MAAM,GAAG,EAAE,CAAC,aAAc,GACxD,CAAE,OAAO,EAAO,MAAO,uDAAwD,GAGjF,CAAE,OAAO,EAAM,OAAQ,EAAK,OAAO,AAAC,CAC7C"}